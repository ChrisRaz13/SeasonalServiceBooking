<!-- Background Animation -->
<div id="particles-js" class="particles-container"></div>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container" @fadeSlideInOut>
  <mat-progress-spinner mode="indeterminate" color="accent"></mat-progress-spinner>
  <p class="loading-text">Loading weather data...</p>
</div>

<!-- Error State -->
<div *ngIf="hasError" class="error-container" @fadeSlideInOut>
  <mat-card>
    <mat-card-content>
      <div class="error-content">
        <h2>‚ö†Ô∏è Unable to load weather data</h2>
        <p>Please try again later or check your connection.</p>
        <button mat-flat-button color="primary" (click)="loadWeatherData()">
          Retry
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Main Content -->
<div *ngIf="!isLoading && !hasError" class="dashboard-container" @scaleIn>
  <!-- Weather Disclaimer -->
  <mat-card class="disclaimer-card">
    <mat-card-content>
      <div class="disclaimer-content">
        <div class="disclaimer-icon">‚ùÑÔ∏è</div>
        <div class="disclaimer-text">
          <p class="primary-text">Weather data provided by the National Weather Service (weather.gov)</p>
          <p class="secondary-text">Service activation is based on snowfall accumulation of 2 inches or more. Updates occur every 60 minutes.</p>
        </div>
        <button mat-button color="primary" (click)="loadWeatherData()" class="refresh-button">
          <span>Refresh Data</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Active Weather Alerts -->
  <div *ngIf="weatherAlerts.length > 0" class="alerts-banner" @fadeSlideInOut>
    <div *ngFor="let alert of weatherAlerts"
         class="alert-item"
         [style.background-color]="getSeverityColor(alert.severity)">
      <div class="alert-header">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <strong>{{ alert.event }}</strong>
      </div>
      <div class="alert-body">
        <p class="alert-headline">{{ alert.headline }}</p>
        <div class="alert-details">
          <p>{{ alert.description }}</p>
          <p *ngIf="alert.instruction"><strong>Instructions:</strong> {{ alert.instruction }}</p>
          <p><strong>Expires:</strong> {{ alert.expires | date:'short' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Snow Conditions Card -->
  <mat-card class="weather-card snow-conditions-card">
    <mat-card-header>
      <mat-card-title>
        <div class="title-with-icon">
          <span class="snow-icon">‚ùÑÔ∏è</span>
          Current Snow Conditions
        </div>
      </mat-card-title>
      <mat-card-subtitle>Service Status & Forecast</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="snow-grid">
        <div class="snow-stat-box">
          <div class="stat-label">Snow Chance</div>
          <div class="stat-value">{{ getSnowProbability() }}%</div>
          <div class="stat-period">Next 12 hours</div>
        </div>

        <div class="snow-stat-box">
          <div class="stat-label">Expected Accumulation</div>
          <div class="stat-value">{{ getSnowAccumulation() }}"</div>
          <div class="stat-period">Total expected</div>
        </div>

        <div class="snow-stat-box" [ngClass]="getServiceStatusClass()">
          <div class="stat-label">Service Status</div>
          <div class="stat-value">{{ getServiceStatus() }}</div>
          <div class="stat-period">Based on forecast</div>
        </div>

        <div class="snow-stat-box">
          <div class="stat-label">Ground Temperature</div>
          <div class="stat-value">{{ getGroundTemperature() }}¬∞F</div>
          <div class="stat-period">Surface conditions</div>
        </div>
      </div>

      <div class="service-notice" *ngIf="showServiceNotice()">
        <p>üö® Approaching service threshold (2" accumulation)</p>
        <button mat-raised-button color="primary">Schedule Service</button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Chart Grid -->
  <div class="chart-grid">
    <!-- Temperature Chart -->
    <mat-card class="weather-card chart-card">
      <mat-card-header>
        <mat-card-title>Temperature Trend</mat-card-title>
        <mat-card-subtitle>Next 24 Hours</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <p-chart type="line"
                  [data]="temperatureData"
                  [options]="temperatureOptions"
                  height="300px">
          </p-chart>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Snow Chart -->
    <mat-card class="weather-card chart-card">
      <mat-card-header>
        <mat-card-title>Snow Forecast</mat-card-title>
        <mat-card-subtitle>Probability & Accumulation</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <p-chart type="line"
                  [data]="snowChartData"
                  [options]="snowChartOptions"
                  height="300px">
          </p-chart>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Hourly Forecast -->
<mat-card class="weather-card hourly-card">
  <mat-card-header>
    <mat-card-title>Hourly Forecast</mat-card-title>
    <mat-card-subtitle>Detailed conditions</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div class="hourly-scroll custom-scrollbar">
      <div *ngFor="let item of hourlyForecast">
        <div *ngIf="item.isDateSeparator" class="date-separator">
          {{ item.date }}
        </div>
        <div *ngIf="!item.isDateSeparator" class="hourly-item">
          <div class="time">{{ item.time }}</div>
          <div class="weather-emoji">{{ getWeatherEmoji(item.shortForecast || '') }}</div>
          <div class="temp">{{ item.temperature }}¬∞F</div>
          <div class="wind">{{ item.windSpeed }}</div>
          <div class="forecast">{{ item.shortForecast }}</div>
          <div class="snow-chance">
            <span>Snow Likely: {{ item.snowChance }}%</span>
          </div>
          <div class="snow-accumulation">
            <span>Accumulation: {{ item.snowAccumulation }}"</span>
          </div>
        </div>
      </div>
    </div>
  </mat-card-content>
</mat-card>


  <!-- 7-Day Forecast -->
  <div class="forecast-section">
    <mat-card class="weather-card forecast-card">
      <mat-card-header>
        <mat-card-title>Extended Forecast</mat-card-title>
        <mat-card-subtitle>7-Day Outlook</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="forecast-timeline">
          <div *ngFor="let forecast of weatherForecast" class="forecast-day">
            <div class="day-header">
              <div class="day-info">
                <span class="day-name">{{ getDayName(forecast.date) }}</span>
                <span class="full-date">{{ getFormattedDate(forecast.date) }}</span>
              </div>
              <div class="temp-range">
                <span class="high" *ngIf="forecast.tempHigh">{{ forecast.tempHigh }}¬∞</span>
                <span class="low" *ngIf="forecast.tempLow">{{ forecast.tempLow }}¬∞</span>
              </div>
            </div>

            <div class="periods-container">
              <div *ngFor="let period of forecast.periods"
                   class="period-card"
                   [class.day-period]="period.isDaytime"
                   [class.night-period]="!period.isDaytime">
                <div class="period-header">
                  <span class="time-label">{{ period.timeOfDay }}</span>
                  <span class="temp-value">{{ period.temperature }}¬∞{{ period.temperatureUnit }}</span>
                </div>

                <div class="period-weather">
                  <span class="weather-emoji">{{ getWeatherEmoji(period.shortForecast) }}</span>
                  <span class="condition">{{ period.shortForecast }}</span>
                </div>

                <div class="snow-info" *ngIf="hasSnowInfo(period)">
                  <div class="snow-chance">
                    <span class="label">Chance of Snow:</span>
                    <span class="value">{{ extractSnowChance(period.shortForecast) }}%</span>
                  </div>
                  <div class="snow-amount" *ngIf="extractHourlyAccumulation(period.detailedForecast) > 0">
                    <span class="label">Expected:</span>
                    <span class="value">{{ extractHourlyAccumulation(period.detailedForecast) }}"</span>
                  </div>
                </div>

                <div class="wind-info">
                  <span class="wind-speed">{{ period.windSpeed }}</span>
                  <span class="wind-direction">{{ period.windDirection }}</span>
                </div>

                <div class="details-expand">
                  <button mat-button color="primary" (click)="toggleDetails(period)">
                    {{ period.showDetails ? 'Less Details' : 'More Details' }}
                  </button>
                </div>

                <div class="detailed-forecast" *ngIf="period.showDetails">
                  {{ period.detailedForecast }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Last Updated Footer -->
  <div class="update-footer">
    <p>Last updated: {{ lastUpdated | date:'medium' }}</p>
    <button mat-button color="primary" (click)="loadWeatherData()">
      <span>Refresh</span>
    </button>
  </div>
</div>
